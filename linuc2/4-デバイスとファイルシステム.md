# デバイスとファイルシステム

## ファイルシステム操作

* VFS

### ファイルシステム情報

/etc/fstab

### mount/umout

### sync

* buffer cache
* page cache

### swap

## ファイルシステム作成

### ext2/ext3/ext4

### XFS

### BtrFS

### mkfsによる作成

### CD/DVD

### 暗号化ファイルシステム

## ファイルシステムの保守

### ファイルシステムの構造

* ext2/ext3
* ect4

### ファイルシステムのチェック

* fsck

### ファイルシステムの管理

### S.M.A.R.T

### XFS

### BtrFS

### オートマウント



### study-memo

## FileSystemの種類

| 名称 | 説明 |
| - | - |
| ext2 | Linux標準、古い |
| ext3 | ext2の後継、ジャーナリング機能がある |
| ext4 | ext3の後継、大容量のファイルシステムをサポート |
| xfs | 古くからありスナップショットの機能がある |
| btrfs | サブボリュームを構成し、スナップショットなどの機能を持つ |
| iso9660 | CD-ROMで使われる |
| FAT/VFAT | Windowsのファイルシステム、UEFIファームウェアのシステムパーティションや、ISOLINUXのイメージなどでも使われる |
| nfts | 近年のWindowsのファイルシステム |
| nfs | ネットワークファイルシステム |
| tmpfs | RAMディスク、メモリ上に配置される |
| swap | 物理メモリのスワップ先として利用される |
| ZFS | OracleのSolalisで使用される、btrfsが参考にした |

各ファイルシステム間の移行は、原則としては現行のデータをバックアップし、新しいファイルシステムを作成したのち、バックアップからコピーをするような形になりますが、一部のファイルシステム間では、コマンドにより変換が可能です。  
例えば、ext2ファイルシステムはtune2fsコマンドを使ってext3に変換が可能ですし、ext3ファイルシステムからbtrfsファイルシステムへの変換はbtrfs-convertというコマンドがあります。
## btrfs

* filesystem show : ファイルシステムの情報を表示する
* subvolume create : サブボリュームの作成
* subvolume delete : サブボリュームの削除
* subvolume list : サブボリュームの一覧表示
* subvolume snapshot : サブボリュームのsnapshot取得

## /etc/fstab

* 書式：  
「デバイス」 「マウント先」 「種類」 「オプション」 「dumpフラグ」 「fsckフラグ」

* オプション:
  * defaults : デフォルト
  * auto : mount -a による自動マウント
  * noauto : 自動マウントしない
  * ro : read only
  * rw : read write 
  * exec : 実行許可
  * noexec : 実行禁止
  * async : 非同期
  * sync : 同期
  * uid : マウントしたファイルシステムの所有者を指定
  * nouser : 一般ユーザによるマウントを禁止
  * user : 一般ユーザによるマウントを許可、マウントしたユーザのみアンマウント可
  * users : 誰でもマウント、アンマウント可

## mount コマンド

* -a : /etc/mtab にあるファイルシステムをすべてマウント
* -o : マウントオプションを指定する
* -t : 指定した種類のファイルシステムのみを対象にする


## fuser コマンド

オプションを指定することで、指定したファイルシステムに対してアクセスを行っているプロセスの一覧を得たり、そのプロセスをすべて kill したりという動作が可能です。

# Filesystemの作成

* mkfs
  * 

* mke2fs
  * -j ext3として作成
  * -b 続けてブロックサイズをbyte単位で指定
  * -m 続けてroot用予備領域の割合を指定
  * -L 続けてボリュームラベル名を指定
  * -n ドライラン
  * -t 続けてファイルシステムの種類を指定

* tune2fs [オプション] デバイス : ext2-4 の設定を行う
  * -c 自動 fsck が行われるまでのマウント回数を設定する
  * -i 自動 fsck が行われるまでの時間を設定する
  * -j ext2 を ext3 に変換する
  * -l スーパーブロックの内容を出力する
  * -m 続けてroot用の予備領域の割合を指定する
  * -L 続けて指定した名前でラベルをつける

* e2label : ext2-4 のラベルを操作

* dumpe2fs : ext2-4 の詳細を表示する

* debugfs : ext2-4 の対話的デバッグを行う

* xfs_admin : xsfの設定を行う

* xfs_info : xfs の情報の詳細を表示する

* 暗号化ボリューム（LUKS)
  * cryptsetup 
    * create 名前 デバイス名 ： マッピング芽唯とデバイスを指定して、暗号化マッピングを作成する
    * remove 名前 : 指定した暗号化マッピングの削除
    * status 名前 : 指定した暗号化マッピングの状態を表示する
  * LUKSコマンド
    * luksFormat デバイス名 : 指定したデバイスをLUKSパーティションとして初期化する
    * luksOpen デバイス名 名前 : デバイスとLUKSパーティション名を指定し、LUKSパーティションを開く
    * luksClose 名前 : 指定したLUKSパーティションを閉じる
    * luksDump デバイス名 : 指定したデバイスの暗号化の状態を表示する
  * デバイスマッパーの機能を使った暗号化を利用している
  * パーティションごとに8つの鍵を持つことができる

* ファイスシステムのチェック
  * リブート後に行う場合、 # shutdown -r -F

* automount  
Linux には、CD/DVD などのメディアやその他の必要な時だけマウントすればよいファイルシステムを、普段はアンマウント状態にしておいて、マウントポイント内にアクセスがあった時には自動でマウントするという仕組みがあります。  
この仕組みをオートマウントといい、automount デーモンというプログラムによりこの仕組みが実現されます。

* UDF  
UDF は 128TB までの容量に対応、512 バイト単位の細かな書き込みに対応、ファイル名は Unicode で 255 文字まで、ディスクの一部が破損しても残りの部分を読み出せる、等々、CD-ROM のファイルフォーマットとして使われる ISO9660 と比較して非常に高性能なファイルシステムです。  
DVD や Blu-ray のファイルシステムとして採用されています。
  * -o 続けてイメージファイル出力先を指定する
  * -J Windows系拡張である Joliet フォーマットで作成する
  * -R Unix系拡張である RockRidge フォーマットで作成する
  * -udf DVDでも用いられるUDFフォーマットで作成する
