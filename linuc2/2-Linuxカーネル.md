# Linuxカーネル

### kernelバージョン
1桁目がメジャーバージョン、2桁目がマイナーバージョン、3桁目が安定板のリリース番号

### 確認コマンド

* # uname -[a|r|m]
* # cat /proc/version
* # head /usr/src/kernels/[version]/Makefile

### カーネルモジュール

コマンド
| コマンド名 | 意味 |
| - | - |
| lsmod | ロードされているモジュールをリスト表示 |
| insmod | モジュールをロードする |
| rmmod | モジュールをアンロードする |
| modprobe | 依存関係を解決してモジュールをロードもしくはアンロードする ( -f : 強制的に操作 -r : アンロードする -l : ロード可能なモジュールを一覧表示 --show-depends : 依存関係を表示 ) |
| depmod | モジュールの依存関係を更新する |
| modinfo | モジュールの情報を表示する |


### カーネルビルド、コンパイル

* ソースを用意する
* .configを設定
* コンパイル
* モジュールをコンパイル
* カーネルとモジュールを配置
* ブートローダの設定変更
* ビルドするときの make のオプション

設定関連

  | オプション | 意味 |
  | - | - |
  | config | 対話的に設定を行う |
  | menuconfig | ターミナル上のGUIで設定を行う |
  | xvonfig | X上のGUIで設定を行う |
  | defconfig | デフォルト状態の設定ファイルを作る定関連 |
  | config | 対話的に設定を行う |
  | menuconfig | ターミナル上のGUIで設定を行う |
  | xvonfig | X上のGUIで設定を行う |
  | defconfig | デフォルト状態の設定ファイルを作る |
  | oldconfig | 現在のカーネルの設定を引き継ぐ |
  | cloneconfig | (oldconfigと同じ) |
  | clean | 設定ファイルを除いて一時ファイルなどを削除 |
  | mrproper | 設定ファイルを含めて一時ファイルを削除 |
  
ビルド関連

  | オプション | 意味 |
  | - | - |
  | all | カーネルとモジュールをビルド, オプションを指定しない場合のデフォルト |
  | install | ビルドしたカーネルをインストール |
  | modules | カーネルモジュールをビルド |
  | modules_install | カーネルモジュールをインストール |
  | rpm | ビルド後にrpmパッケージ化 |
  | rpm-pkg | ソースrpmパッケージを作る |
  | binrpm-pkg | バイナリ rpm パッケージを作る |
  | deb-pkg | Debian パッケージを作る  |

### カーネルソース

/usr/src/linux

### カーネルの開発ブランチのカテゴリ

* prepatch:Release Candidate
* mainline:prepatch後に出る正式版
* stable:mainlineの後に出る安定板
* longterm:stableの中から選ばれ、長期的にサポートされる

### カーネルの管理と問題解決

* /proc  
カーネル内のデータへのインタフェイスとなる特殊なファイルシステム
* コマンド  
  * $ lsdev  
  * $ lspci
  * $ lsusb

### カーネルパラメータの設定変更

* sysctl  
  * sysctl カーネルパラメータ ⇒ 表示  
  * sysctl -w カーネルパラメータ=値 ⇒ 設定  
  * sysctl -a ⇒ 一覧表示

/proc/sys/* は、仮想ファイル  
カーネルパラメータが直接記載されている、変更も可能

### カーネルイメージ

* bzImage  
  bzImage1はカーネルイメージ（ファイルとして保存されたカーネル本体のデータ）を圧縮し、自己伸長できるようにした形式。bzImageより古いzImageは「512KB以下制限」があった。  
  gzip圧縮で、現在の主に利用されている。

## 初期RAMディスク

初期 RAM ディスクは、システム起動時に仮の環境としてまずメモリ上にファイルシステムを展開し、そこでカーネルを動作させてから本来のファイルシステムをルートにマウントし直す、といった段階的なブートを実現する機能。  
システムの起動時に用いられ、メモリ上にファイルシステムを展開し、そこでカーネルを動作させてから本来のファイルシステムをルートにマウントし直す。

* initrd:ファイルシステムイメージを圧縮したもの、古い
* initramfs:ファイルシステムのドライバが不要、上位互換、cpioアーカイブをgzip圧縮

* initrd.imgをマウント  
  \# mount -o loop initrd.img マウントポイント

* mkinitrd [RAMディスクイメージファイル] [カーネルパージョン]  
* mkinitramfs -o [RAMディスクイメージファイル] [カーネルバージョン]

Dracut:udevに対応

## デバイスファイル

* /dev ディレクトリ以下にある、デバイスを抽象化したファイル
  * ブロックデバイス：ファイルタイプb ブロック単位でデバイスにアクセス、HDD,RAM,などボリューム
  * キャラクタデバイス：ファイルタイプc 文字単位でデバイスにアクセス、キーボードやマウスなど、I/O
* /udev
  * あらかじめ /dev 配下に用意する必要があない動的なデバイスファイル管理、ユーザー空間、sysfsが /udev からのアクセスをカーネル空間とつなぐ
  * udevadm info  
  * udevadm monitor
  * 設定ファイル /etc/udev/udev.conf

* udev関連コマンド  
  * udevcontrol udevを操作し、動作・停止などを行う
  * udevinfo udevが認識しているデバイス情報を表示する
  * udevmonitor udevの動作状況を監視し、コンソールに出力する
  * udevadm [オプション] 上記のコマンドを統合した新しいコマンド
